<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>المطبخ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  .order-box {
    border: 1px solid #333;
    border-radius: 10px;
    padding: 15px;
    margin: 10px;
    min-width: 220px;
    max-width: 300px;
    background-color: #f8f9fa;
  }
</style>
</head>
<body>

<!-- جرس عند وصول طلب جديد -->
<audio id="orderBell" src="bell.mp3" preload="auto"></audio>

<div class="container">
  <h1>طلبات المطبخ</h1>
  <div id="ordersContainer" class="d-flex flex-wrap justify-content-start"></div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzaUMk8kzIZx2KsCaA1VAnRrmtHc8cgfsZhVX3Dxl-ikcsfYCayNZgV6tQU5jZtdCA/exec";

// لتتبع عدد الطلبات السابقة
let lastOrderCount = 0;

// جلب الطلبات من Google Sheets
async function loadOrders() {
  try {
    const res = await fetch(SCRIPT_URL);
    const data = await res.json();

    const container = document.getElementById('ordersContainer');
    container.innerHTML = '';

    // فقط الطلبات بحالة pending
    const pending = data.filter(o => o.status === "pending");

    // جرس عند وصول طلب جديد
    if(pending.length > lastOrderCount && lastOrderCount !== 0){
      document.getElementById('orderBell').play();
    }
    lastOrderCount = pending.length;

    if(pending.length === 0){
      container.innerHTML = "<h2>لا توجد طلبات حالياً ✅</h2>";
      return;
    }

    pending.forEach(order => {
      const div = document.createElement('div');
      div.className = 'order-box';
      
      // عرض الأصناف بشكل سطر جديد لكل صنف
      let items;
      try { 
        items = JSON.parse(order.items); 
      } catch {
        items = [];
      }
      let itemsStr = items.map(i => `${i.item} × ${i.qty}`).join("<br>");

      div.innerHTML = `<h4>طلب #${order.id}</h4>
                       <p>${itemsStr}</p>
                       <p><strong>المجموع: ${order.total} ليرة</strong></p>
                       <button class="btn btn-danger btn-sm mt-2" onclick="finishPrep(this)">تم التحضير</button>`;
      container.appendChild(div);
    });

  } catch(err){
    console.error("خطأ عند جلب الطلبات:", err);
  }
}

// إنهاء التحضير مؤقتاً في الصفحة
function finishPrep(btn){
  btn.parentElement.remove();
  lastOrderCount--;
}

loadOrders();
// تحديث الطلبات كل 5 ثوانٍ
setInterval(loadOrders, 5000);
</script>

</body>
</html>
